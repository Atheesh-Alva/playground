env:
  PR_TITLE: Testing PR Creation
  PR_BODY: This is the body!
  REVIEWER: ${{ secrets.PR_REVIEWER_ATHEESH }}
  LABEL: bug # documentation,duplicate,enhancement,"good first issue","help wanted",invalid,question,wontfix
  FLUTTER_VERSION: "3.22.0"

  ISSUE_TITLE: Testing PR Creation
  ISSUE_BODY: This is the body!
  ISSUE_LABEL: bug # documentation,duplicate,enhancement,"good first issue","help wanted",invalid,question,wontfix

name: Development Actions

on:
    push:
        branches:
          - 'DEV*'
        tags:
          - 'PR-*'

    pull_request_review:
        types: [submitted]

jobs:
    CheckAction:
        name: Check type of Action
        runs-on: ubuntu-latest

        env:
            ENV_ACTION_TYPE:
            ENV_ISSUE_NUMBER:

        steps:
          - name: Extract from Commit Message
            if: github.ref_type == 'tag'
            run: echo "ENV_ACTION_TYPE=$(echo ${{ github.ref_name }} | cut -d- -f1)" >> $GITHUB_ENV

          - name: Extract Issue Number
            if: ${{ env.ENV_ACTION_TYPE == 'FIXES' }}
            run: echo "ENV_ISSUE_NUMBER=$(echo ${{ github.ref_name }} | cut -d- -f2)" >> $GITHUB_ENV

          - name: Check PR Review Approved
            if: github.event_name == 'pull_request_review' && github.event.review.state == 'APPROVED'
            run: echo "ENV_ACTION_TYPE=PR_MERGE" >> $GITHUB_ENV

          - name: Export Outputs
            id: set-action-type
            run: |
                echo "ACTION_TYPE=${{ env.ENV_ACTION_TYPE }}" >> $GITHUB_OUTPUT
                echo "ISSUE_NUMBER=${{ env.ENV_ISSUE_NUMBER }}" >> $GITHUB_OUTPUT

        outputs:
            ACTION_TYPE: ${{ steps.set-action-type.outputs.ACTION_TYPE }}
            ISSUE_NUMBER: ${{ steps.set-action-type.outputs.ISSUE_NUMBER }}

    CICD:
        if: false
        name: Development Actions
        needs: CheckAction
        runs-on: ubuntu-latest
        permissions: write-all

        env:
            SOURCE_BRANCH: # DO NOT CHANGE
            ASSIGNEE: ${{ github.event.sender.login }}
            FLUTTER_HOME:
            ACTION_TYPE: ${{ needs.CheckAction.outputs.ACTION_TYPE }}
            ENV_ISSUE_NUMBER: ${{ needs.CheckAction.outputs.ISSUE_NUMBER }}

        steps:
          - name: Checkout Code
            uses: actions/checkout@v3
            with:
                fetch-depth: 0

          - name: MS Teams Notification - Flutter Team
            if: always()
            uses: freenet-actions/ms-teams-deploy-card@master
            id: ms_teams_ostrum
            with:
                github-token: ${{ github.token }}
                webhook-uri: ${{ secrets.MS_TEAMS_PLAYGROUND_WEBHOOK_URI }}
                show-on-start: false
                card-layout-exit: complete
                enable-review-diffs-action: false
                include-files: false
                custom-facts: |
                  - name: While Merging PR
                    value: "https://www.ostrumtech.com/"
                custom-actions: |
                  - text: While Merging PR
                    url: "https://www.ostrumtech.com/privacy-policy/"

          - name: Get Source Branch
            if: ${{ env.ACTION_TYPE == 'PR' }}
            run: |
                branch=$(git branch -r --contains ${{ github.ref }} --format "%(refname:lstrip=3)")
                echo "SOURCE_BRANCH=$branch" >> $GITHUB_ENV

        #   - name: Flutter Setup
        #     if: ${{ env.ACTION_TYPE == 'PR' }}
        #     uses: subosito/flutter-action@v2
        #     with:
        #         channel: "stable"
        #         flutter-version: ${{ env.FLUTTER_VERSION }}
        #         cache: true

        # - name: Flutter Clean
            # if: ${{ env.ACTION_TYPE == 'PR' }}
        #   run: flutter clean

        # - name: Flutter Pub Get
            # if: ${{ env.ACTION_TYPE == 'PR' }}
        #   run: flutter pub get
        
        # - name: 'Cache pub dependencies'
            # if: ${{ env.ACTION_TYPE == 'PR' }}
        #   uses: actions/cache@v3
        #   with:
        #     path: ${{ env.FLUTTER_HOME }}/.pub-cache
        #     key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        #     restore-keys: ${{ runner.os }}-pub-

          - name: Create Pull Request 
            if: ${{ env.ACTION_TYPE == 'PR' }}
            run: |
                gh pr create \
                --base ${{ secrets.PR_DESTINATION_BRANCH }} \
                --head ${{ env.SOURCE_BRANCH }} \
                --title 'Auto create - ${{ github.ref_name }}: ${{ env.PR_TITLE }}' \
                --body 'Created by ${{ github.event.sender.login }}: ${{ env.PR_BODY }}' \
                --reviewer ${{ env.REVIEWER }} \
                --assignee ${{ env.ASSIGNEE }} \
                --label ${{ env.LABEL }}
            env:
                GITHUB_TOKEN: ${{ github.token }}
        
          - name: Auto-merge Pull Request on Approval
            if: ${{ env.ACTION_TYPE == 'PR_MERGE' }}
            run: gh pr merge --merge --auto "${{ github.event.pull_request.number }}"
            env:
                GH_TOKEN: ${{ github.token }}

          - name: Create an Issue
            if: ${{ env.ACTION_TYPE == 'ISSUE' }}
            uses: actions-ecosystem/action-create-issue@v1
            with:
                github_token: ${{ secrets.github_token }}
                title: 'Auto create - ${{ github.ref_name }}: ${{ env.ISSUE_TITLE }}'
                body: 'Created by ${{ github.event.sender.login }}: ${{ env.ISSUE_BODY }}'
                labels: ${{ env.ISSUE_LABEL }}

          - name: Close Issue
            if: ${{ env.ACTION_TYPE == 'FIXES' }}
            uses: peter-evans/close-issue@v3
            with:
                issue-number: ${{ env.ENV_ISSUE_NUMBER }}
                comment: Auto-closing issue




#         - name: Extract Tag details
#           run: |
#             echo "ENV_VERSION=$(echo ${{ github.ref_name }} | sed 's/.*-//')" >> $GITHUB_ENV
#             echo "ENV_ACTION_TYPE=$(echo ${{ github.ref_name }} | sed 's/-.*//')" >> $GITHUB_ENV
